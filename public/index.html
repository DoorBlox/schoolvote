<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>IPSA Presidential Election</title>
  <link rel="stylesheet" href="/style.css"/>
  <script src="https://unpkg.com/html5-qrcode@2.3.10/html5-qrcode.min.js"></script>
</head>
<body>
  <div class="container">
    <div class="card">
      <h1>IPSA Presidential Election</h1>
      <div class="small">school vote app made by hisyam - 4ever - ©2025</div>
      <div class="hr"></div>

      <!-- In-app browser warning injected by script if needed -->

      <div id="gate">
        <p>Scan your token QR or type your token:</p>
        <div class="row">
          <input id="token" placeholder="Enter token manually" style="flex:1"/>
          <button id="manualBtn" onclick="continueToken()">Continue</button>
        </div>

        <div id="scan" style="margin-top:12px">
          <div class="row" style="gap:8px;margin-bottom:8px">
            <select id="cameraSel" style="display:none"></select>
            <button id="startBtn" style="display:none" onclick="startScan()">Start camera</button>
            <button id="stopBtn" style="display:none;background:#374151" onclick="stopScan()">Stop</button>
          </div>
          <div id="reader" style="width:320px;height:auto"></div>
          <div class="small" id="scanMsg"></div>
        </div>

        <div id="err" class="bad small"></div>
      </div>

      <div id="ballot" style="display:none">
        <h2 id="roleHeadline"></h2>
        <div id="choices"></div>
        <div class="row" style="margin-top:12px">
          <button onclick="submitVote()">Submit vote</button>
          <button onclick="resetGate()">Cancel</button>
        </div>
        <div id="voteErr" class="bad small"></div>
      </div>

      <div id="thanks" style="display:none">
        <h2>Thank you!</h2>
        <p class="small">Your vote was recorded. Returning to gate…</p>
      </div>
    </div>
  </div>

<script>
/* ---------- In-app browser notice (camera often blocked there) ---------- */
(function () {
  const ua = navigator.userAgent || '';
  const inApp = /(FBAN|FBAV|Instagram|Line|WeChat|FB_IAB|Twitter|TikTok)/i.test(ua);
  if (inApp) {
    const msg = document.createElement('div');
    msg.className = 'card';
    msg.style.marginBottom = '12px';
    msg.innerHTML = `
      <div class="bad small">
        You’re using an in-app browser that may block the camera.
        Please open this page in Safari/Chrome.
        <div style="margin-top:8px">
          <a class="link" href="${location.href}" target="_blank" rel="noopener">Open in your browser</a>
        </div>
      </div>`;
    document.querySelector('.container')?.prepend(msg);
  }
})();
</script>

<script>
/* ---------- State ---------- */
let tokenValue = '';
let ballotRule = '';
let maleCandidates = [], femaleCandidates = [];
let qrObj = null;
let cameras = [];
let currentCamId = null;

/* ---------- Utils ---------- */
function byId(id){ return document.getElementById(id); }
function show(el, on){ if (!el) return; el.style.display = on ? '' : 'none'; }
function showErr(m){ byId('err').innerText = m || ''; }
function showVoteErr(m){ byId('voteErr').innerText = m || ''; }
function scanMsg(m){ byId('scanMsg').innerText = m || ''; }

/* ---------- Camera flow ---------- */
async function initScanUI(){
  // Hide UI bits until ready
  show(byId('startBtn'), false);
  show(byId('stopBtn'), false);
  show(byId('cameraSel'), false);

  // HTTPS hint
  if (!window.isSecureContext) {
    scanMsg('Open this page over HTTPS to use the camera. You can still type the token.');
    return;
  }

  scanMsg('Preparing camera…');
  try {
    if (!window.Html5Qrcode) throw new Error('QR library not loaded');

    // Enumerate cameras
    cameras = await Html5Qrcode.getCameras();

    if (!cameras || !cameras.length) {
      scanMsg('No camera found. You can type the token instead.');
      return;
    }

    // Prefer a back camera if label hints it
    const rear = cameras.find(c => /back|rear|environment/i.test(c.label));
    currentCamId = (rear || cameras[0]).id;

    // Populate selector if >1 camera
    const sel = byId('cameraSel');
    sel.innerHTML = '';
    if (cameras.length > 1) {
      for (const c of cameras) {
        const opt = document.createElement('option');
        opt.value = c.id;
        opt.textContent = c.label || 'Camera';
        if (c.id === currentCamId) opt.selected = true;
        sel.appendChild(opt);
      }
      sel.onchange = () => { currentCamId = sel.value; restartScan(); };
      show(sel, true);
    }

    // Try to auto-start; if the browser requires a gesture, show Start button
    const ok = await tryStart(currentCamId, true);
    if (!ok) {
      show(byId('startBtn'), true);
      scanMsg('Tap “Start camera” to begin scanning.');
    }
  } catch (e) {
    console.log(e);
    scanMsg('Unable to access camera. Open in Safari/Chrome (not an in-app browser), ensure HTTPS, and allow camera permission. You can still type the token.');
    show(byId('startBtn'), true);
  }
}

async function tryStart(camId, silent=false){
  try {
    // If a previous instance is running, stop it before starting a new one
    if (qrObj) {
      try { await qrObj.stop(); } catch {}
    }
    qrObj = new Html5Qrcode('reader');

    await qrObj.start(
      camId,
      { fps: 10, qrbox: 220 },
      onScan,
      () => {} // onScanFailure noop
    );
    show(byId('stopBtn'), true);
    scanMsg('Camera active. Point at the QR token.');
    return true;
  } catch (e) {
    console.log('start error', e);
    if (!silent) scanMsg('Could not start camera. Tap “Start camera” or try another browser.');
    return false;
  }
}

async function startScan(){
  show(byId('startBtn'), false);
  const ok = await tryStart(currentCamId, false);
  if (!ok) show(byId('startBtn'), true);
}

async function stopScan(){
  if (qrObj) {
    try { await qrObj.stop(); } catch {}
  }
  show(byId('stopBtn'), false);
}

async function restartScan(){
  await stopScan();
  setTimeout(()=> startScan(), 150);
}

function onScan(decoded){
  tokenValue = (decoded || '').trim();
  if (!tokenValue) return;
  stopScan();
  byId('token').value = tokenValue;
  continueToken();
}

/* ---------- Gate & ballot flow ---------- */
async function continueToken(){
  tokenValue = byId('token').value.trim();
  if (!tokenValue) return showErr('Enter a token');
  showErr('');
  try{
    const r = await fetch('/api/public/validate_token', {
      method:'POST', headers:{'content-type':'application/json'},
      body: JSON.stringify({ token: tokenValue })
    });
    const j = await r.json();
    if (!j.ok) return showErr(j.error || 'Server error');

    ballotRule = j.rule;
    maleCandidates = j.maleCandidates || [];
    femaleCandidates = j.femaleCandidates || [];
    renderBallot(j.role);
  }catch(e){
    console.log(e);
    showErr('Server error');
  }
}

function renderBallot(role){
  byId('gate').style.display='none';
  byId('ballot').style.display='block';
  const h = byId('roleHeadline');
  const wrap = byId('choices');
  wrap.innerHTML = ''; showVoteErr('');

  if (role === 'male'){
    h.innerText = 'Choose ONE male candidate';
    wrap.innerHTML = maleCandidates.map(c=>`<label><input type="radio" name="male" value="${c}"> ${c}</label><br>`).join('');
  } else if (role === 'female'){
    h.innerText = 'Choose ONE female candidate';
    wrap.innerHTML = femaleCandidates.map(c=>`<label><input type="radio" name="female" value="${c}"> ${c}</label><br>`).join('');
  } else {
    h.innerText = 'Choose ONE male and ONE female candidate';
    wrap.innerHTML = `
      <div><strong>Male</strong><br>${maleCandidates.map(c=>`<label><input type="radio" name="male" value="${c}"> ${c}</label><br>`).join('')}</div>
      <div style="height:8px"></div>
      <div><strong>Female</strong><br>${femaleCandidates.map(c=>`<label><input type="radio" name="female" value="${c}"> ${c}</label><br>`).join('')}</div>
    `;
  }
}

function resetGate(){
  stopScan();
  byId('ballot').style.display='none';
  byId('thanks').style.display='none';
  byId('gate').style.display='block';
  byId('token').value='';
  tokenValue=''; ballotRule='';
  initScanUI(); // re-prepare camera UI
}

async function submitVote(){
  const male = document.querySelector('input[name="male"]:checked')?.value;
  const female = document.querySelector('input[name="female"]:checked')?.value;

  if (ballotRule==='vote_one_male' && !male) return showVoteErr('Pick one male candidate');
  if (ballotRule==='vote_one_female' && !female) return showVoteErr('Pick one female candidate');
  if (ballotRule==='vote_one_each' && (!male || !female)) return showVoteErr('Pick one male and one female');

  try{
    const r = await fetch('/api/public/submit_vote', {
      method:'POST', headers:{'content-type':'application/json'},
      body: JSON.stringify({ token: tokenValue, male, female })
    });
    const j = await r.json();
    if (!j.ok) return showVoteErr(j.error || 'Server error');

    byId('ballot').style.display='none';
    byId('thanks').style.display='block';
    setTimeout(()=>{ resetGate(); }, 5000);
  }catch(e){
    console.log(e);
    showVoteErr('Server error');
  }
}

/* ---------- Boot ---------- */
window.addEventListener('load', initScanUI);
</script>
</body>
</html>