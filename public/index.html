<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>IPSA Presidential Election</title>

  <link rel="stylesheet" href="/style.css"/>

  <!-- We will load html5-qrcode dynamically inside the script (with fallbacks) -->

  <style>
    /* Floating white logo tab */
    .logo-card{
      display:inline-flex; align-items:center; gap:14px;
      padding:10px 16px; border-radius:14px; background:#fff;
      box-shadow:0 6px 20px rgba(0,0,0,.18);
      margin:-6px auto 14px; max-width:92%;
    }
    .logos{ display:flex; justify-content:center }
    .logos img{ height:42px; width:auto; object-fit:contain }

    /* The QR container MUST have a real height */
    #reader{ width:100%; max-width:480px; height:280px; margin:0 auto; }

    .small{ font-size:.9rem; opacity:.85 }
    .bad{ color:#ff6b6b }
    .link{ color:#7c9cff; text-decoration:underline }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <!-- floating white tab with logos -->
      <div class="logos">
        <div class="logo-card">
          <img src="/ipsa-logo.png" alt="IPSA" onerror="this.style.display='none'">
          <img src="/school-logo.png" alt="School" onerror="this.style.display='none'">
        </div>
      </div>

      <h1>IPSA Presidential Election</h1>
      <div class="small">school vote app made by hisyam - 4ever - ©2025</div>
      <div class="hr"></div>

      <!-- Gate -->
      <div id="gate">
        <p>Scan your token QR or type your token:</p>

        <div class="row">
          <input id="token" placeholder="Enter token manually" style="flex:1"/>
          <button id="manualBtn" onclick="continueToken()">Continue</button>
        </div>

        <div id="scan" style="margin-top:12px">
          <!-- reader box first -->
          <div id="reader"></div>
          <div class="small" id="scanMsg" style="margin-top:6px;text-align:center"></div>

          <!-- controls BELOW the reader -->
          <div class="row" style="gap:8px;margin-top:8px;flex-wrap:wrap;justify-content:center">
            <select id="cameraSel" style="display:none"></select>
            <button id="startBtn" style="display:none" onclick="startScan()">Start camera</button>
            <button id="stopBtn" style="display:none;background:#374151" onclick="stopScan()">Stop</button>
          </div>
        </div>

        <div id="err" class="bad small" style="margin-top:8px"></div>

        <details style="margin-top:10px">
          <summary class="small">Camera help</summary>
          <div class="small" style="margin-top:6px">
            If the camera doesn’t start:
            <ul style="margin:6px 0 0 16px">
              <li>Open in Safari/Chrome (not an in-app browser).</li>
              <li>Allow camera permission for this site.</li>
              <li>Tap <b>Start camera</b> if auto-start is blocked.</li>
              <li>Try switching camera in the selector.</li>
            </ul>
          </div>
        </details>
      </div>

      <!-- Ballot -->
      <div id="ballot" style="display:none">
        <h2 id="roleHeadline"></h2>
        <div id="choices"></div>
        <div class="row" style="margin-top:12px">
          <button onclick="submitVote()">Submit vote</button>
          <button onclick="resetGate()">Cancel</button>
        </div>
        <div id="voteErr" class="bad small" style="margin-top:6px"></div>
      </div>

      <!-- Thanks -->
      <div id="thanks" style="display:none">
        <h2>Thank you!</h2>
        <p class="small">Your vote was recorded. Returning to gate…</p>
      </div>
    </div>
  </div>

  <!-- In-app browser warning -->
  <script>
    (function () {
      const ua = navigator.userAgent || '';
      const inApp = /(FBAN|FBAV|Instagram|Line|WeChat|FB_IAB|Twitter|TikTok)/i.test(ua);
      if (!inApp) return;
      const msg = document.createElement('div');
      msg.className = 'card';
      msg.style.marginBottom = '12px';
      msg.innerHTML = `
        <div class="bad small">
          You’re using an in-app browser that may block the camera.
          Please open this page in Safari/Chrome.
          <div style="margin-top:8px">
            <a class="link" href="${location.href}" target="_blank" rel="noopener">Open in your browser</a>
          </div>
        </div>`;
      document.querySelector('.container')?.prepend(msg);
    })();
  </script>

  <!-- Main page logic -->
  <script>
    /* ---------- Robust loader for html5-qrcode (tries 3 CDNs) ---------- */
    function loadScript(src){
      return new Promise((res, rej) => {
        const s = document.createElement('script');
        s.src = src; s.async = true;
        s.onload = res; s.onerror = rej;
        document.head.appendChild(s);
      });
    }

    async function ensureQrLib(){
      if (window.Html5Qrcode) return true;
      const urls = [
        '/vendor/html5-qrcode.min.js',  // <-- local first
        'https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js',
        'https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.8/html5-qrcode.min.js',
        'https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js'
      ];
      for (const u of urls){
        try {
          await loadScript(u);
          if (window.Html5Qrcode) return true;
        } catch (e) {
          console.log('QR lib load failed:', u, e);
        }
      }
      return false;
    }

    /* ---------- State ---------- */
    let tokenValue = '';
    let ballotRule = '';
    let maleCandidates = [], femaleCandidates = [];
    let qrObj = null;
    let cameras = [];
    let currentCamId = null;

    /* ---------- Utils ---------- */
    const byId = (id) => document.getElementById(id);
    const show = (el, on) => { if (el) el.style.display = on ? '' : 'none'; };
    const showErr = (m) => { byId('err').innerText = m || ''; };
    const showVoteErr = (m) => { byId('voteErr').innerText = m || ''; };
    const scanMsg = (m) => { byId('scanMsg').innerText = m || ''; };

    /* ---------- Camera flow ---------- */
    async function initScanUI(){
      show(byId('startBtn'), false);
      show(byId('stopBtn'), false);
      show(byId('cameraSel'), false);
      byId('reader').style.height = '280px'; // guarantee non-zero height

      if (!window.isSecureContext) {
        scanMsg('Open this page over HTTPS to use the camera. You can still type the token.');
        return;
      }

      scanMsg('Loading camera…');
      const okLib = await ensureQrLib();
      if (!okLib){
        scanMsg('QR library failed to load. Check network/firewall, then reload.');
        show(byId('startBtn'), true);
        return;
      }

      try {
        cameras = await Html5Qrcode.getCameras();
        if (!cameras || !cameras.length){
          scanMsg('No camera found. You can type the token instead.');
          return;
        }
        const rear = cameras.find(c => /back|rear|environment/i.test(c.label));
        currentCamId = (rear || cameras[0]).id;

        const sel = byId('cameraSel');
        sel.innerHTML = '';
        if (cameras.length > 1){
          for (const c of cameras){
            const opt = document.createElement('option');
            opt.value = c.id;
            opt.textContent = c.label || 'Camera';
            if (c.id === currentCamId) opt.selected = true;
            sel.appendChild(opt);
          }
          sel.onchange = () => { currentCamId = sel.value; restartScan(); };
          show(sel, true);
        }

        const started = await tryStart(currentCamId, true);
        if (!started){
          show(byId('startBtn'), true);
          scanMsg('Tap “Start camera” to begin scanning.');
        }
      } catch (e){
        console.log(e);
        scanMsg('Unable to access camera. Use Safari/Chrome (not an in-app browser), allow permissions, or type your token.');
        show(byId('startBtn'), true);
      }
    }

    async function tryStart(camId, silent=false){
      const r = byId('reader');
      if (!r.style.height || (r.clientHeight || 0) < 120) r.style.height = '280px';
      const w = r.clientWidth || 320;
      const h = r.clientHeight || 280;

      try {
        if (qrObj) { try { await qrObj.stop(); } catch {} }
        qrObj = new Html5Qrcode('reader', { verbose:false });

        const box = Math.min(320, Math.floor(Math.min(w, h) * 0.9));
        const camConfig = { deviceId: { exact: camId } };

        await qrObj.start(
          camConfig,
          {
            fps: 10,
            qrbox: { width: box, height: box },
            aspectRatio: 1.7778,
            experimentalFeatures: { useBarCodeDetectorIfSupported: true },
            rememberLastUsedCamera: true
          },
          onScan,
          () => {}
        );
        show(byId('stopBtn'), true);
        scanMsg('Camera active. Point at the QR token.');
        return true;
      } catch (e){
        console.log('start error', e);
        const msg = (e && (e.message || e.name)) ? `Could not start camera: ${e.message || e.name}` : 'Could not start camera.';
        if (!silent) scanMsg(msg + ' Tap “Start camera” or try another browser.');
        return false;
      }
    }

    async function startScan(){
      show(byId('startBtn'), false);
      const ok = await tryStart(currentCamId, false);
      if (!ok) show(byId('startBtn'), true);
    }

    async function stopScan(){
      if (qrObj) { try { await qrObj.stop(); } catch {} }
      show(byId('stopBtn'), false);
    }

    async function restartScan(){
      await stopScan();
      setTimeout(()=> startScan(), 150);
    }

    function onScan(decoded){
      tokenValue = (decoded || '').trim();
      if (!tokenValue) return;
      stopScan();
      byId('token').value = tokenValue;
      continueToken();
    }

    /* ---------- Gate & ballot ---------- */
    async function continueToken(){
      tokenValue = byId('token').value.trim();
      if (!tokenValue) return showErr('Enter a token');
      showErr('');
      try{
        const r = await fetch('/api/public/validate_token', {
          method:'POST', headers:{'content-type':'application/json'},
          body: JSON.stringify({ token: tokenValue })
        });
        const j = await r.json();
        if (!j.ok) return showErr(j.error || 'Server error');

        ballotRule = j.rule;
        maleCandidates = j.maleCandidates || [];
        femaleCandidates = j.femaleCandidates || [];
        renderBallot(j.role);
      }catch(e){ console.log(e); showErr('Server error'); }
    }

    function renderBallot(role){
      byId('gate').style.display='none';
      byId('ballot').style.display='block';
      const h = byId('roleHeadline');
      const wrap = byId('choices');
      wrap.innerHTML = ''; showVoteErr('');

      if (role === 'male'){
        h.innerText = 'Choose ONE male candidate';
        wrap.innerHTML = maleCandidates.map(c=>`<label><input type="radio" name="male" value="${c}"> ${c}</label><br>`).join('');
      } else if (role === 'female'){
        h.innerText = 'Choose ONE female candidate';
        wrap.innerHTML = femaleCandidates.map(c=>`<label><input type="radio" name="female" value="${c}"> ${c}</label><br>`).join('');
      } else {
        h.innerText = 'Choose ONE male and ONE female candidate';
        wrap.innerHTML = `
          <div><strong>Male</strong><br>${maleCandidates.map(c=>`<label><input type="radio" name="male" value="${c}"> ${c}</label><br>`).join('')}</div>
          <div style="height:8px"></div>
          <div><strong>Female</strong><br>${femaleCandidates.map(c=>`<label><input type="radio" name="female" value="${c}"> ${c}</label><br>`).join('')}</div>
        `;
      }
    }

    function resetGate(){
      stopScan();
      byId('ballot').style.display='none';
      byId('thanks').style.display='none';
      byId('gate').style.display='block';
      byId('token').value='';
      tokenValue=''; ballotRule='';
      initScanUI();
    }

    async function submitVote(){
      const male = document.querySelector('input[name="male"]:checked')?.value;
      const female = document.querySelector('input[name="female"]:checked')?.value;

      if (ballotRule==='vote_one_male' && !male) return showVoteErr('Pick one male candidate');
      if (ballotRule==='vote_one_female' && !female) return showVoteErr('Pick one female candidate');
      if (ballotRule==='vote_one_each' && (!male || !female)) return showVoteErr('Pick one male and one female');

      try{
        const r = await fetch('/api/public/submit_vote', {
          method:'POST', headers:{'content-type':'application/json'},
          body: JSON.stringify({ token: tokenValue, male, female })
        });
        const j = await r.json();
        if (!j.ok) return showVoteErr(j.error || 'Server error');

        byId('ballot').style.display='none';
        byId('thanks').style.display='block';
        setTimeout(()=>{ resetGate(); }, 5000);
      }catch(e){
        console.log(e); showVoteErr('Server error');
      }
    }

    /* ---------- Boot & cleanup ---------- */
    window.addEventListener('load', initScanUI);
    window.addEventListener('beforeunload', () => { try { if (qrObj) qrObj.stop(); } catch {} });
  </script>
</body>
</html>